<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.shinnlove.springbootall.db.dao.UserPkGlobalStatRepo">

    <insert id="insertUserGlobalStat" useGeneratedKeys="true" keyProperty="entity.id">
        insert into ${tableName} (activity_id, guid, total_success_count,
                                  total_failure_count, total_draw_count,
                                  promotion_level)
        values (
                   #{entity.activityId,jdbcType=VARCHAR},
                   #{entity.guid,jdbcType=BIGINT},
                   #{entity.totalSuccessCount,jdbcType=INTEGER},
                   #{entity.totalFailureCount,jdbcType=INTEGER},
                   #{entity.totalDrawCount,jdbcType=INTEGER},
                   #{entity.promotionLevel,jdbcType=INTEGER}
               )
            ON DUPLICATE KEY
        UPDATE total_success_count = #{entity.totalSuccessCount};
    </insert>

    <select id="queryUserGlobalStat" resultType="com.shinnlove.springbootall.db.po.UserPkGlobalStatEntity">
        SELECT id, activity_id, guid, total_success_count,
               total_failure_count, total_draw_count,
               promotion_level, create_time, update_time
        FROM ${tableName}
        WHERE `activity_id` = #{activityId} AND `guid` = #{guid}
        ORDER BY `create_time` DESC
    </select>

    <update id="updateGlobalSuccess">
        UPDATE ${tableName}
        SET `total_success_count` = `total_success_count` + 1
        WHERE `activity_id` = #{activityId} AND `guid` = #{guid}
    </update>

    <update id="updateGlobalSuccessWithPromotionLevel">
        UPDATE ${tableName}
        SET `total_success_count` = `total_success_count` + 1,
            `promotion_level` = `promotion_level` + 1,
            WHERE `activity_id` = #{activityId} AND `guid` = #{guid}
    </update>

    <update id="updateGlobalFailure">
        UPDATE ${tableName}
        SET `total_failure_count` = `total_failure_count` + 1
        WHERE `activity_id` = #{activityId} AND `guid` = #{guid}
    </update>

    <update id="updateGlobalDraw">
        UPDATE ${tableName}
        SET `total_draw_count` = `total_draw_count` + 1
        WHERE `activity_id` = #{activityId} AND `guid` = #{guid}
    </update>

</mapper>
